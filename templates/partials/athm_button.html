{% load django_athm %}
{% athm_button ATHM_CONFIG %}

<script>
(function() {
    async function handleCallback(response, callbackName) {
        console.log(`ATHM ${callbackName}:`, response);

        // ATH MÃ³vil SDK may call callbacks with undefined during initialization - ignore these
        if (!response) {
            return;
        }

        // DEBUG: Only process final statuses, ignore intermediate ones
        const status = response.ecommerceStatus;
        console.log(`ecommerceStatus: ${status}`);
        if (!status || !['COMPLETED', 'CANCELLED', 'CANCEL', 'EXPIRED'].includes(status)) {
            console.log('Ignoring non-final status');
            return;
        }

        const payload = {...response};
        if (payload.items && typeof payload.items !== 'string') {
            payload.items = JSON.stringify(payload.items);
        }

        try {
            const result = await fetch("{% url 'django_athm:athm_callback' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams(payload)
            });

            if (result.ok) {
                const data = await result.json();
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                }
            }
        } catch (error) {
            console.error('Callback error:', error);
        }
    }

    window.authorizationATHM = (r) => handleCallback(r, 'authorizationATHM');
    window.cancelATHM = (r) => handleCallback(r, 'cancelATHM');
    window.expiredATHM = (r) => handleCallback(r, 'expiredATHM');
})();
</script>
